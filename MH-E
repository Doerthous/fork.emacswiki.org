[[es:MheEs]]

'''MH-E''' is the Emacs frontend to '''MH''' (the //Rand Mail Handler//).

MH is a ''mail user agent'' (MUA) for the unix shell.
Instead of being one monolithic program, it is a collection of small tools, which makes it easy to use and maintain.

== Usage ==

This short example uses:

* `nmh' - the most popular MH implementation
* `msmtp' - For sending mail via SMTP
* `MH-E' - As the client used to manage your mail

Disclaimer: The `inc' command, used in this tutorial, will //delete// the files from your remote inbox after downloading them to your computer. Keep this in mind.

=== MH / nmh ===

To use MH-E, you will need MH on your computer. The most popular implementation of MH is `nmh', which you should be able to install from your package manager.

Once you have nmh, you will need to create a file in your home directory named <code>.mh_profile</code>, that looks like this:

{{{
Path: mail
Local-Mailbox: Me <me@example.com>
send: -mts sendmail/pipe -sendmail /usr/bin/msmtp
inc: -host mail.example.com -user me@example.com
}}}

* `Path' - Where MH looks for, and stores, email. Relative to the <code>~/.mh_profile</code> file.
* `Local-Mailbox' - Your "From:" field
* `send' - How mail is sent. We tell nmh to send mail with sendmail, but we specify msmtp as our sendmail program.
* `inc' - Our POP account, so MH can download mail directly from the remote server.

If you would like `inc' to store your password, create a file named `~/.netrc' that contains:

{{{
machine    mail.example.com
  login    me@example.com
  password p4ssw0rd
}}}

=== msmtp ===

'''msmtp''' is a //Mail Transfer Agent// (MTA), which is used to send mail via SMTP. You should be able to install the `msmtp' package from your computer's package manager.

Create the file <code>~/.msmtp</code>, which contains something like this:

{{{
defaults

port     587
tls      on
account  main
host     mail.example.com
from     me@example.com

auth     on
user     me@example.com
password p4ssw0rd

account default : main
}}}

* `port' - The SMTP port
* `tls' - Use TLS (required by some SMTP servers)
* `account' - The name of our profile (can be anything)
* `host' - The address of our SMTP server
* `from' - Our email address
* `auth' - We're using a username/password
* `user' - The username of our account
* `password' - Our email password
* `account default' - Which account to use (we only have the one)

Now that SMTP is configured via msmtp, we can send mail!

=== MH-E ===

Start MH-E from Emacs with <code>M-x mh-nmail</code>. This will open your MH inbox.

You can control mh-nmail with the following keys:

* `i' - Get new mail (with the 'inc' command)
* `o' - Move message to another folder
* `r' - Reply to current message
* `s' - Start writing a new email
* `F v' - Visit another folder
* `n/p' - Next / previous message in current folder
* <code>?</code> - See a small help menu.

= About the documentation =

MH-E has it's own InfoMode documentation which comes with Emacs. The most recent version
is 8.0 which is now being kept in sync with the released version of the
software. [http://sourceforge.net/forum/forum.php?forum_id=566555]

In many MH-E submodes, pressing <code>?</code> provides a quick list of keybindings.

There is also the book by Jerry Peek: <i>[https://rand-mh.sourceforge.io/book/ MH & nmh: Email for Users & Programmers]</i>.

= Forums =

Several mailinglists exist on SourceForge, namely "mh-e-announce",
"mh-e-devel" and "mh-e-users".  All of these are bidirectionally
gatewayed via the marvellous Gmane, which lives at
http://www.gmane.org.  Through this service one can access the lists
not only with HTTP (SourceForge provides this too), but with NNTP.
Fancy that!  Contact the NNTP server '''news.gmane.org'''

= Making MH-E dance to your tune =

When configuring, it is often a good idea to tweak the natural files of
''MH'' itself, the <code>.mh_profile</code> for example.  This is the
general way to configure things, and all the changes will inherit to
any frontends.
If you shun such a blasphemous suggestion, remember
that this is only a suggestion of an Unix Zealot who wishes to:

* a) also use mh via shell, and
* b) digs generality.

So go ahead, just fiddle
with the mh-* variables if you feel like it.  Of course there are many
options which make no sense to mh itself, and these frontend-specific
things are to be set within the frontend itself.  Like any large and
decent EmacsLisp package, MH-E has it's own group for the common
user-friendly CustomizingAndSaving interface '''Customize''' to be
accessed with the `customize-group'.

If you'd like to configure MH-E to be your preferred mail-composing
system, set `mail-user-agent' to
<code>'mh-e-user-agent</code>.  If you're using GnuEmacs, you can
also prefer MH-E for reading your mail, by setting `read-mail-command'
to <code>'mh-rmail</code>.

= Basic MH-E setup with nmh, fetchmail and msmtp =
msmtp is useful when you have more than one mail addresses. It reads "From:" field and uses corresponding account. Should be built with GNU TLS support to be used with gmail (make WITH_GNUTLS=YES).

Assuming you have already installed nmh, fetchmail and msmtp.

.emacs:

     (setq mh-send-uses-spost-flag t)
     (setq mail-user-agent 'mh-e-user-agent)

mts.conf (mine is here: /usr/local/etc/nmh/mts.conf):

     sendmail: /home/username/.msmtp-envelope-from.sh
     mts: sendmail
     masquerade: draft_from

.msmtp-envelope-from.sh:

     #!/bin/sh
     # can't just write "sendmail: /usr/local/bin/msmtp --read-envelope-from" in mts.conf
     # so it's a little workaround
     # makes msmtp to read "From:" field and to use corresponding account
     /usr/local/bin/msmtp --read-envelope-from $*

.mh_profile:

     Path: Mail
     postproc: /usr/local/libexec/nmh/spost

.fetchmailrc:

     poll pop.yandex.ru with proto POP3
       user 'username' password 'userpass'
    
     poll pop.gmail.com with proto POP3
       user 'username' password 'userpass' options ssl
       sslcertck sslcertpath /home/banan/.certs/

.msmtp:

     # username@yandex.ru
     account yandex
     host smtp.yandex.ru
     from username@yandex.ru
     auth login
     user username
     password userpass
 
     # username@gmail.com
     account gmail
     host smtp.gmail.com
     port 587
     from username@gmail.com
     auth on
     user username@gmail.com
     password userpass
     tls on
     tls_trust_file /home/banan/.certs/ThawtePremiumServerCA.crt

Also place "From: Your Name <username@gmail.com>" before "To:" in these files in ~/Mail: components, replcomps, forwcomps. After that you can send your mail using any of your accounts by editing "From:" field in your mail composing buffer.

[http://www.axllent.org/docs/networking/gmail_pop3_with_fetchmail How to get gmail certificates for fetchmail]

!ThawtePremiumServerCA.crt for gmail support in msmtp you can get here (I renamed !ThawtePremiumServerCA_b64.txt) : https://www.verisign.com/support/thawte-roots.zip

When certificates are in ~/.certs/, do "$ c_rehash ~/.certs/"

For lazy guys here are three certificates, ~/.certs/gmail.pem:

   -----BEGIN CERTIFICATE-----
   MIIC3TCCAkagAwIBAgIDCDijMA0GCSqGSIb3DQEBBQUAME4xCzAJBgNVBAYTAlVT
   MRAwDgYDVQQKEwdFcXVpZmF4MS0wKwYDVQQLEyRFcXVpZmF4IFNlY3VyZSBDZXJ0
   aWZpY2F0ZSBBdXRob3JpdHkwHhcNMDcxMDI1MTc1MzE2WhcNMDkxMjI0MTg1MzE2
   WjBoMQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMN
   TW91bnRhaW4gVmlldzEUMBIGA1UEChMLR29vZ2xlIEluYy4xFjAUBgNVBAMTDXBv
   cC5nbWFpbC5jb20wgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBAO03QxerFKZV
   8yeomuL4zSl8Pr7hMWnKMMgp/CwhwadeBmL0LQHHbjL/6z/Z59ZQvrztqkwhchA2
   APKzUwRVTyn7Shx6vBqk6oFmTqoOLmY6hbq6l8uVdUv0AfbHwio8CnLpK2+nbuFl
   flPwx1DH0E3grD8+CrH5SmScfTWbDkcXAgMBAAGjga4wgaswDgYDVR0PAQH/BAQD
   AgTwMB0GA1UdDgQWBBTJRG/OFpZt+BV43JM3NshHMjpwazA6BgNVHR8EMzAxMC+g
   LaArhilodHRwOi8vY3JsLmdlb3RydXN0LmNvbS9jcmxzL3NlY3VyZWNhLmNybDAf
   BgNVHSMEGDAWgBRI5mj5K9KylddH2CMgEE8zmJCf1DAdBgNVHSUEFjAUBggrBgEF
   BQcDAQYIKwYBBQUHAwIwDQYJKoZIhvcNAQEFBQADgYEAOKr3mhxtwFCS3J6lbeaf
   3KrHKi935BZkI75sRbON+hog0t2ovcM2i7fxs3xneH8USLsHgfxNBj9tkMogMK/K
   sO/NUVZ/IfyqcNNkp2619qTQXthKRH42JKpAKgNhT1bdno3pxn+eDEpqmU3CE7IP
   HDCjWOK1fGkZ/yFAuTxuxAc=
   -----END CERTIFICATE-----

~/.certs/equifax.pem:

   -----BEGIN CERTIFICATE-----
   MIIDIDCCAomgAwIBAgIENd70zzANBgkqhkiG9w0BAQUFADBOMQswCQYDVQQGEwJV
   UzEQMA4GA1UEChMHRXF1aWZheDEtMCsGA1UECxMkRXF1aWZheCBTZWN1cmUgQ2Vy
   dGlmaWNhdGUgQXV0aG9yaXR5MB4XDTk4MDgyMjE2NDE1MVoXDTE4MDgyMjE2NDE1
   MVowTjELMAkGA1UEBhMCVVMxEDAOBgNVBAoTB0VxdWlmYXgxLTArBgNVBAsTJEVx
   dWlmYXggU2VjdXJlIENlcnRpZmljYXRlIEF1dGhvcml0eTCBnzANBgkqhkiG9w0B
   AQEFAAOBjQAwgYkCgYEAwV2xWGcIYu6gmi0fCG2RFGiYCh7+2gRvE4RiIcPRfM6f
   BeC4AfBONOziipUEZKzxa1NfBbPLZ4C/QgKO/t0BCezhABRP/PvwDN1Dulsr4R+A
   cJkVV5MW8Q+XarfCaCMczE1ZMKxRHjuvK9buY0V7xdlfUNLjUA86iOe/FP3gx7kC
   AwEAAaOCAQkwggEFMHAGA1UdHwRpMGcwZaBjoGGkXzBdMQswCQYDVQQGEwJVUzEQ
   MA4GA1UEChMHRXF1aWZheDEtMCsGA1UECxMkRXF1aWZheCBTZWN1cmUgQ2VydGlm
   aWNhdGUgQXV0aG9yaXR5MQ0wCwYDVQQDEwRDUkwxMBoGA1UdEAQTMBGBDzIwMTgw
   ODIyMTY0MTUxWjALBgNVHQ8EBAMCAQYwHwYDVR0jBBgwFoAUSOZo+SvSspXXR9gj
   IBBPM5iQn9QwHQYDVR0OBBYEFEjmaPkr0rKV10fYIyAQTzOYkJ/UMAwGA1UdEwQF
   MAMBAf8wGgYJKoZIhvZ9B0EABA0wCxsFVjMuMGMDAgbAMA0GCSqGSIb3DQEBBQUA
   A4GBAFjOKer89961zgK5F7WF0bnj4JXMJTENAKaSbn+2kmOeUJXRmm/kEd5jhW6Y
   7qj/WsjTVbJmcVfewCHrPSqnI0kBBIZCe/zuf6IWUrVnZ9NA2zsmWLIodz2uFHdh
   1voqZiegDfqnc1zqcPGUIWVEX/r87yloqaKHee9570+sB3c4
   -----END CERTIFICATE-----

~/.certs/!ThawtePremiumServerCA.crt

   -----BEGIN CERTIFICATE-----
   MIIDJzCCApCgAwIBAgIBATANBgkqhkiG9w0BAQQFADCBzjELMAkGA1UEBhMCWkEx
   FTATBgNVBAgTDFdlc3Rlcm4gQ2FwZTESMBAGA1UEBxMJQ2FwZSBUb3duMR0wGwYD
   VQQKExRUaGF3dGUgQ29uc3VsdGluZyBjYzEoMCYGA1UECxMfQ2VydGlmaWNhdGlv
   biBTZXJ2aWNlcyBEaXZpc2lvbjEhMB8GA1UEAxMYVGhhd3RlIFByZW1pdW0gU2Vy
   dmVyIENBMSgwJgYJKoZIhvcNAQkBFhlwcmVtaXVtLXNlcnZlckB0aGF3dGUuY29t
   MB4XDTk2MDgwMTAwMDAwMFoXDTIwMTIzMTIzNTk1OVowgc4xCzAJBgNVBAYTAlpB
   MRUwEwYDVQQIEwxXZXN0ZXJuIENhcGUxEjAQBgNVBAcTCUNhcGUgVG93bjEdMBsG
   A1UEChMUVGhhd3RlIENvbnN1bHRpbmcgY2MxKDAmBgNVBAsTH0NlcnRpZmljYXRp
   b24gU2VydmljZXMgRGl2aXNpb24xITAfBgNVBAMTGFRoYXd0ZSBQcmVtaXVtIFNl
   cnZlciBDQTEoMCYGCSqGSIb3DQEJARYZcHJlbWl1bS1zZXJ2ZXJAdGhhd3RlLmNv
   bTCBnzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEA0jY2aovXwlue2oFBYo847kkE
   VdbQ7xwblRZH7xhINTpS9CtqBo87L+pW46+GjZ4X9560ZXUCTe/LCaIhUdib0GfQ
   ug2SBhRz1JPLlyoAnFxODLz6FVL88kRu2hFKbgifLy3j+ao6hnO2RlNYyIkFvYMR
   uHM/qgeN9EJN50CdHDcCAwEAAaMTMBEwDwYDVR0TAQH/BAUwAwEB/zANBgkqhkiG
   9w0BAQQFAAOBgQAmSCwWwlj66BZ0DKqqX1Q/8tfJeGBeXm43YyJ3Nn6yF8Q0ufUI
   hfzJATj/Tb7yFkJD57taRvvBxhEf8UqwKEbJw8RCfbz6q1lu1bdRiBHjpIUZa4JM
   pAwSremkrj/xw0llmozFyD4lt5SZu5IycQfwhl7tUCemDaYj+bvLpgcUQg==
   -----END CERTIFICATE-----

Important! Do not forget to "$ c_rehash ~/.certs/"

= Add-ons =

MhBiff ([http://www.yynet.tama.tokyo.jp/~yokota/mh-biff/ Website])is a mail-notification tool. MhCrypt,
(Lisp:mh-crypt.el) is an utility to store the messages in an encrypted
format.  With a quick glance it seems this would break mh outside of
MH-E.

= Alternative to MhBiff =

For those who do not understand japanese well, there is another way to get mail notification: (display-time) function with some tweaks (useful in case of multiple mail folders)

    ;; Notification stuff: use display-time minor mode to notify about new mail
    ;; in mode-line, but omit time and load info. Print comma separated list
    ;; of folders with new mail in mode-line.
    (setq display-time-mail-function
          (lambda ()
            (let ((input (shell-command-to-string "/usr/local/nmh/bin/flist -all"))
                  (dirs nil)
                  (start 0))
              (while (string-match "^\\([a-z-+]*\\) *has [1-9].*$" input start)
                (push (match-string 1 input) dirs)
                (setq start (match-end 0)))
              (setq display-time-mail-string (mapconcat 'identity dirs ", ")))))
								  
    (setq display-time-interval 10
          display-time-format ""
          display-time-default-load-average nil
          display-time-mail-face 'custom-themed)
    
    (display-time)

= Other MH Clients =

Aside from Emacs' MH-E, you can control MH through various shell commands (see
the manpages for '''nmh'''(1) or '''mh-chart'''(1))

Then there are the GUI clients, '''xmh''' and exmh, written in
Tcl%%/%%Tk.

There's another Emacs interface called '''tmh''', written by ThienThiNguyen, but
since it hasn't been updated since late 1994. It has been archived at the
author's webpage at 
= External Links =

* [http://savannah.nongnu.org Savannah]
* [http://www.nongnu.org/nmh nmh's website]
* [http://mh-e.sourceforge.net MH-E's homeage]
* [http://www.yynet.tama.tokyo.jp/~yokota/mh-biff/ MH-Biff]
* [http://rand-mh.sourceforge.net/book/ Jerry Peek's MH book]
* [http://exmh.sourceforge.net/ Exmh's homepage]
* [http://www.gnuvola.org/software/tmh/ tmh archived page]
* [http://dir.gmane.org/index.php?prefix=gmane.mail.mh-e Directory of MH-E groups]
* [https://sourceforge.net/p/mh-e/mailman/ MH-E mailing lists on SourceForge]

----

CategoryMail
